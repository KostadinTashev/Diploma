{% extends 'base/base.html' %}
{% load static %}

{% block page_content %}
<div class="container py-4">
    <div class="card shadow">
        <div class="card-body">
            <h3 class="mb-4">Назначи програма на {{ client.user.full_name }}</h3>

            <form method="post">
                {% csrf_token %}
                {{ formset.management_form }}

                <div id="formset-container">
                    {% for form in formset %}
                        <div class="program-form border p-3 mb-3 position-relative rounded shadow-sm">
                            {{ form.id }}

                            <div class="mb-2">
                                {{ form.date.label_tag }} {{ form.date }}
                            </div>

                            <div class="mb-2">
                                {{ form.workout.label_tag }} {{ form.workout }}
                            </div>

                            {{ form.DELETE }}

                            <button type="button"
                                    class="btn btn-outline-danger btn-sm remove-form-btn position-absolute top-0 end-0 m-2">
                                <i class="bi bi-trash"></i> Премахни
                            </button>
                        </div>
                    {% endfor %}
                </div>

                <button type="button" id="add-form-btn" class="btn btn-outline-success mt-2">
                    <i class="bi bi-plus-circle"></i> Добави тренировка
                </button>

                <button type="submit" class="btn btn-primary mt-3">Запази</button>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const container = document.getElementById("formset-container");
        const addBtn = document.getElementById("add-form-btn");
        const totalForms = document.getElementById("id_form-TOTAL_FORMS");

        function updateIndexes() {
            const forms = container.querySelectorAll(".program-form");
            totalForms.value = forms.length;

            forms.forEach((form, index) => {
                form.querySelectorAll("input, select, textarea, label").forEach((el) => {
                    if (el.name) el.name = el.name.replace(/form-\d+-/, `form-${index}-`);
                    if (el.id) el.id = el.id.replace(/form-\d+-/, `form-${index}-`);
                    if (el.htmlFor) el.htmlFor = el.htmlFor.replace(/form-\d+-/, `form-${index}-`);
                });
            });
        }

        addBtn.addEventListener("click", function () {
            const forms = container.querySelectorAll(".program-form");
            const lastForm = forms[forms.length - 1];
            const newForm = lastForm.cloneNode(true);

            newForm.querySelectorAll("input, select").forEach((el) => {
                if (el.type !== "hidden") el.value = "";
                if (el.type === "checkbox") el.checked = false;
            });

            container.appendChild(newForm);
            updateIndexes();
        });

        container.addEventListener("click", function (e) {
            if (e.target.classList.contains("remove-form-btn") || e.target.closest(".remove-form-btn")) {
                const btn = e.target.closest(".remove-form-btn");
                const form = btn.closest(".program-form");
                const deleteInput = form.querySelector('input[type="checkbox"][name*="-DELETE"]');

                if (deleteInput) {
                    deleteInput.checked = true;
                    form.style.display = "none";
                }

                updateIndexes();
            }
        });
    });
</script>

<style>
    input[type="checkbox"][name$="-DELETE"] {
        display: none;
    }
</style>
{% endblock %}
